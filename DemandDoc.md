# 需求文档

## 项目介绍

​	本项目为 BUPT 2022春操作系统大作业, 乙方为BUPT 操作系统课程设计的负责教师.

​	项目承接方为 306班CatusOS团队

## 需求说明

### 整体需求

​	项目题目: 操作系统模拟程序的设计与实现

​	项目目标: 设计并实现一个具有操作系统基本功能的软件

​	此外, 本项目实现的操作系统运行环境为模拟环境, 即QEMU软件提供的RISC-V硬件环境

### 功能需求

#### 模块划分

其中实现的目标软件核心需求是具有操作系统的基本功能, 包括以下内容: 

​	进程管理功能

​	内存管理功能

​	文件系统

​	设备管理

## 具体功能需求

### 运行隔离机制

本需求需要利用到RISC-V平台提供的CSR寄存器进行控制.

#### 特权级切换

需要实现 Machine/ Supervisor / User 三个模式的切换

用户程序运行在User模式下

操作系统内核运行在Supervisor模式下

OpenSBI运行在Machine模式下

#### 用户应用程序隔离

需要实现两个功能:

- 程序不能访问任意的地址空间
- 程序执行不同段的指令需要权限

### 进程管理

#### 进程系统库

​	部分参考POSIX, 待完善

#### 进程结构

​	PCB是CatusOS中表示进程的核心结构类型,  PCB的设计可以参考Linux系统

​	需要包含的内容有: process运行的代码段, 父子进程, 状态, 内存映射表,上下文.



​	除了PCB外, 还需要管理和控制Process所需要的资源, 提供Process运行所需的信息:

​	进程的内核栈, pid

​		

#### 进程调度

进程调度的核心是queue和scheduler

##### 功能1 Queue Structure

Queue保存处于ready和wait状态的进程, scheduler需要操作的内容有:

将初始化进程, 并将进程加入到ready queue中.

阻塞进程, 将process加入到wait queue中, 或者等待event到来后将process踢出wait queue

##### 功能2 Scheduler Algorithm

Scheduler主要任务操作进程进出以上的Queue, Scheduler可以分为 long-term, mid-term, short-term.  CatusOS最基本要实现long-term和short-term的功能.

##### 功能3 Context Switch

需求待完善



#### 多线程模型(optional)

实现多线程可以实现并发编程, CatusOS需要实现信号量,锁等机制

- 功能1: 线程同步控制原语
- 功能2: 线程的创建和调度



### 内存管理

#### 虚实交换的魔法

现代操作系统为了避免在运行多个进程时, 进程之间可能会出现内存冲突, 或者访问其他进程内存造成不安全后果的问题. 提出了分页式存储管理的方法.

CatusOS需要实现分页式存储管理的基本功能:

- 功能1: 提供page index存放的空间, 并且编写page walker
- 功能2: 利用CPU提供的MMU和TLB结构, 实现物理地址和虚拟地址之间的转换
- 功能3: 处理缺页异常程序, 实现page demand
- 功能4: 读取程序的ELF信息, 为其提供可支持运行的内存结构

#### 内存接口

实现stdlib.h下的内存分配相关的函数

包括

- malloc(), realloc(), calloc()
- free()

#### 堆内存分配器

每一个进程都有一个堆空间, allocator会针对这一个空间内的内存进行分配和回收

- 功能1: 完成进程提出的内存分配和内存回收请求
- 功能2: 实现一个内存分配算法(待定
- 目标: 尽可能提高性能指标, 减少内外碎片



### 文件系统

#### 文件系统接口

catusOS需要提供程序可以利用于文件读写的api

	- 功能1: file descriptor, 文件描述符
	- 功能2: fopen 和 fclose 等文件系统api

#### 使用inode的文件结构

待完善

#### 块设备驱动与接口

文件系统需要读写以硬盘为例的块设备, catusOS需要实现与快设备之间读写的驱动

包括用于避免频繁读写的块设备缓存, 以及块设备管理数据结构

- 功能1: 块设备管理驱动
- 功能2: 块设备接口
- 功能3: 块设备缓存



​	

​	